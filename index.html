<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Setup</title>
        <style>
            input{
                width:80%;
            }
        </style>
        <script>
            async function check(){
                let jsonurl=document.getElementById("json").value;
                let pyramids=document.getElementById("pyramids").value;
                let log=document.getElementById("log");
                log.innerText="";
                if(!jsonurl.length)return;
                let json=await fetch(jsonurl).then(response=>response.json()).catch(exception=>exception);
                if(json instanceof Error){
                    log.innerText=`Can't access JSON descriptor at ${jsonurl}. Please verify that the link is correct and that it's available for cross-site access ("CORS").`;
                    return;
                }
                let slices=json.slices;
                let length=slices.length;
                if(!pyramids.length){
                    log.innerText=`${jsonurl} contains ${length} images. Please provide location of pyramids.`;
                    return;
                }
                let pyramidbase=(pyramids.startsWith("bucket/")?
                    "https://data-proxy.ebrains.eu/api/v1/public/":
                    "https://object.cscs.ch/v1/AUTH_08c08f9f119744cbbf77e216988da3eb/")+pyramids;
                let fail=false;
                for(let i=0;i<length;i++){
                    let slice=slices[i];
                    let old=log.innerText;
                    log.innerText+=`${i+1}/${length}, ${slice.filename}`;
                    let name=slice.filename;
                    name=name.substring(0,name.lastIndexOf("."));
                    let descriptor=await fetch(`${pyramidbase}/${slice.filename}/${name}.dzi`).then(response=>response.text()).catch(exception=>exception);
                    if(descriptor instanceof Error){
                        log.innerText+=" - can't access DZI descriptor\n";
                        fail=true;
                    }else
                        log.innerText=old;
                }
                if(fail)
                    log.innerText+="Check failed."
                else{
                    let baselink=`https://localizoom.apps.hbp.eu/filmstripzoom.html?atlas=${atlas.value}&series=${jsonurl}&pyramids=${pyramids}`;
                    let antools=`${baselink}&tools`;
                    let nltools=`${antools}&nl`;
                    log.innerHTML=`Viewer: <a target="_blank" href="${baselink}">${baselink}</a><br>
        Annotation tools: <a target="_blank" href="${antools}">${antools}</a><br>
        Nonlinear tools: <a target="_blank" href="${nltools}">${nltools}</a>`;
                }
            }
        </script>
    </head>
    <body>
        LocaliZoom link configurator<br>
        <input type="text" id="json" placeholder="Complete URL for JSON, https://object.cscs.ch/.../xy.json" oninput="check()"><br>
        <input type="text" id="pyramids" placeholder="Container ID only, like &quot;imgsvc-17b7fa98-a152-995b-86d2-fde75106ce0f&quot;, or a collab-slug prefixed with &quot;bucket/&quot;" oninput="check()"><br>
        <select id="atlas">
            <option value="WHS_SD_Rat_v4_39um">WHS SD Rat v4 39um</option>
            <option value="WHS_SD_Rat_v3_39um">WHS SD Rat v3 39um</option>
            <option value="WHS_SD_Rat_v2_39um">WHS SD Rat v2 39um</option>
            <option value="ABA_Mouse_CCFv3_2017_25um">AMBA CCFv3 2017 25um</option>
            <option value="ABA_Mouse_CCFv3_2015_25um">AMBA CCFv3 2015 25um</option>
            <option value="ABA_Mouse_CCFv2_25um">AMBA CCFv2 25um</option>
        </select>
        <button onclick="location.href='filmstripzoom.html?atlas='+atlas.value+'&series='+json.value+'&amp;pyramids='+pyramids.value">Go</button>
        <hr>
        Test dataset: <a href="#" onclick="atlas.selectedIndex=3;json.value='Test/E15.json';pyramids.value='imgsvc-7e9a11b7-b27f-67d7-95c8-3b72bb5086e9';check()">E15</a>
        <hr>
        <div id="log"></div>
    </body>
</html>
